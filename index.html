<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulir Kinerja Harian Pegawai - RSUD Prambanan</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
        }
        
        body {
            margin: 20px;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.25 !important;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #2c3e50;
            padding-bottom: 20px;
        }
        
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            line-height: 1.25;
        }
        
        .header-info-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        input[type="text"],
        input[type="date"],
        input[type="time"],
        select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .default-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            grid-column: span 4;
        }
        
        .month-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        
        .table-container {
            overflow-x: auto;
            margin-bottom: 15px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            line-height: 1.0 !important;
            font-size: 11px;
        }
        
        th {
            background-color: #2c3e50;
            color: white;
            padding: 8px 6px;
            text-align: center;
            border: 1px solid #ddd;
            line-height: 1.0 !important;
            height: 15px;
            font-size: 11px;
            font-weight: bold;
        }
        
        td {
            padding: 6px 4px;
            border: 1px solid #ddd;
            text-align: center;
            vertical-align: top;
            line-height: 1.0 !important;
            height: 15px;
            font-size: 11px;
        }
        
        .date-header {
            background-color: #ecf0f1;
            font-weight: bold;
        }
        
        .date-cell {
            vertical-align: middle;
            font-weight: bold;
            background-color: #f8f9fa;
            min-width: 120px;
            height: 15px;
        }
        
        .holiday-row {
            background-color: #fff5f5;
        }
        
        .holiday-cell {
            background-color: #ffe6e6;
            color: #cc0000;
        }
        
        .activity-container {
            padding: 2px;
            min-width: 200px;
        }
        
        .activity-row {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
            gap: 4px;
        }
        
        .activity-row:last-child {
            margin-bottom: 0;
        }
        
        .time-input-group {
            display: flex;
            align-items: center;
            gap: 3px;
            width: 100%;
        }
        
        .time-input {
            width: 45%;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 11px;
            height: 24px;
        }
        
        .activity-input {
            flex: 1;
            width: 100%;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 11px;
            resize: vertical;
            min-height: 50px;
            box-sizing: border-box;
            line-height: 1.0 !important;
        }
        
        .action-buttons-cell {
            width: 140px;
            min-width: 140px;
        }
        
        .action-buttons-small {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        
        .btn {
            padding: 6px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            font-weight: bold;
            transition: all 0.3s;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 28px;
            line-height: 1.0;
        }
        
        .btn-add {
            background-color: #27ae60;
            color: white;
        }
        
        .btn-add:hover {
            background-color: #219653;
        }
        
        .btn-replicate {
            background-color: #3498db;
            color: white;
        }
        
        .btn-replicate:hover {
            background-color: #2980b9;
        }
        
        .btn-remove {
            background-color: #e74c3c;
            color: white;
            padding: 6px 8px;
        }
        
        .btn-remove:hover {
            background-color: #c0392b;
        }
        
        .btn-clear-day {
            background-color: #f39c12;
            color: white;
        }
        
        .btn-clear-day:hover {
            background-color: #e67e22;
        }
        
        .btn-primary {
            background-color: #2c3e50;
            color: white;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .btn-primary:hover {
            background-color: #1a252f;
        }
        
        .btn-default {
            background-color: #9b59b6;
            color: white;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .btn-default:hover {
            background-color: #8e44ad;
        }
        
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 15px;
            margin-bottom: 15px;
        }
        
        .footer {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
            display: flex;
            justify-content: flex-end;
        }
        
        .signature-section {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            width: 300px;
        }
        
        .signature-content {
            text-align: left;
            width: 100%;
        }
        
        .signature-line {
            margin-bottom: 15px;
        }
        
        .signature-line p {
            margin: 2px 0;
            line-height: 1.25;
        }
        
        .signature-space {
            margin-top: 60px;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            width: 500px;
            max-width: 90%;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .close-modal:hover {
            color: #333;
        }
        
        .option-container {
            margin: 15px 0;
        }
        
        .option-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .option-item:hover {
            background-color: #f5f5f5;
        }
        
        .option-item.selected {
            background-color: #e3f2fd;
            border-color: #2196f3;
        }
        
        .option-item input {
            margin-right: 10px;
        }
        
        @media print {
            @page {
                margin: 2.54cm !important;
            }
            
            body {
                background-color: white;
                margin: 0;
                padding: 0;
                font-size: 11px !important;
                line-height: 1.25 !important;
            }
            
            .container {
                box-shadow: none;
                padding: 0;
                margin: 0;
                width: 100%;
            }
            
            .no-print {
                display: none !important;
            }
            
            table {
                border: 1px solid #000;
                font-size: 10px !important;
                page-break-inside: auto;
                width: 100%;
                line-height: 1.0 !important;
                margin-top: 10px !important;
            }
            
            tr {
                page-break-inside: avoid;
                page-break-after: auto;
                height: 15px !important;
            }
            
            th, td {
                border: 1px solid #000;
                padding: 6px 4px !important;
                line-height: 1.0 !important;
                height: 15px !important;
                font-size: 10px !important;
            }
            
            .btn {
                display: none;
            }
            
            .activity-input {
                border: none;
                min-height: auto;
                padding: 0;
                width: 100%;
                font-size: 10px !important;
            }
            
            .print-table th:nth-child(1) { width: 5%; }
            .print-table th:nth-child(2) { width: 55%; }
            .print-table th:nth-child(3) { width: 15%; }
            .print-table th:nth-child(4) { width: 10%; }
            .print-table th:nth-child(5) { width: 10%; }
            
            .print-activity-row {
                display: table-row !important;
            }
            
            .print-time {
                white-space: nowrap;
            }
            
            .holiday-row td {
                background-color: #fff !important;
                color: #000 !important;
            }
            
            .footer, .signature-section {
                display: flex !important;
                justify-content: flex-end !important;
                margin-top: 15px !important;
            }
            
            .signature-content {
                text-align: left;
                width: 300px;
            }
            
            .print-header {
                display: block !important;
                margin-bottom: 15px;
            }
            
            .input-header {
                display: none !important;
            }
            
            .print-header h1 {
                line-height: 1.25 !important;
                margin-bottom: 15px;
                font-size: 14px !important;
            }
            
            .print-header p {
                margin: 2px 0 !important;
                line-height: 1.25 !important;
                font-size: 11px !important;
            }
        }
        
        .instructions {
            background-color: #f8f9fa;
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
            line-height: 1.25;
            font-size: 12px;
        }
        
        .instructions h3 {
            margin-top: 0;
            color: #2c3e50;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .print-header {
            text-align: center;
            margin-bottom: 20px;
            display: none;
        }
        
        @media print {
            .print-header {
                display: block !important;
            }
        }
        
        .day-name {
            font-size: 10px;
            color: #666;
            font-weight: normal;
        }
        
        .separator {
            color: #999;
            margin: 0 3px;
        }
        
        .holiday-text {
            color: #cc0000;
            font-style: italic;
            font-size: 10px;
        }
        
        .col-no { 
            width: 5% !important;
            min-width: 40px;
            max-width: 40px;
        }
        .col-date { 
            width: 15% !important;
            min-width: 130px;
            max-width: 130px;
        }
        .col-time { 
            width: 20% !important;
            min-width: 150px;
        }
        .col-activity { 
            width: 50% !important;
            min-width: 350px;
        }
        .col-actions { 
            width: 10% !important;
            min-width: 140px;
            max-width: 140px;
        }
        
        .inner-table {
            width: 100%;
            border: none;
        }
        
        .inner-table td {
            border: none;
            padding: 1px;
        }
        
        .time-header {
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .activity-desc-container {
            position: relative;
        }
        
        .activity-desc-row {
            display: flex;
            align-items: flex-start;
            margin-bottom: 3px;
            width: 100%;
        }
        
        .activity-desc-row:last-child {
            margin-bottom: 0;
        }
        
        .desc-remove-btn {
            margin-left: 3px;
            margin-top: 3px;
            padding: 4px 6px;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            height: 24px;
        }
        
        .desc-remove-btn:hover {
            background-color: #c0392b;
        }
        
        @media (max-width: 1200px) {
            .header-info-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .header-info-grid {
                grid-template-columns: 1fr;
            }
            
            .btn {
                font-size: 9px;
                padding: 4px 6px;
                min-height: 24px;
            }
            
            .col-no, .col-date, .col-time, .col-activity, .col-actions {
                min-width: auto;
                max-width: none;
            }
        }
        
        .fixed-table {
            table-layout: fixed;
        }
        
        .fixed-table td {
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .activity-time-cell {
            min-width: 150px;
        }
        
        .activity-desc-cell {
            min-width: 350px;
        }
        
        p, h1, h2, h3, h4, h5, h6 {
            margin-top: 0;
            margin-bottom: 0;
            padding-top: 0;
            padding-bottom: 0;
        }
        
        .container p {
            margin-bottom: 5px;
        }
        
        .signature-line p {
            margin: 2px 0;
            line-height: 1.25;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header input-header no-print">
            <h1>FORMULIR KINERJA HARIAN PEGAWAI</h1>
            <div class="header-info-grid">
                <div class="form-group">
                    <label for="nama">NAMA PEGAWAI</label>
                    <input type="text" id="nama" placeholder="Nama Pegawai">
                </div>
                <div class="form-group">
                    <label for="nipPegawai">NIP PEGAWAI</label>
                    <input type="text" id="nipPegawai" placeholder="NIP Pegawai">
                </div>
                <div class="form-group">
                    <label for="bulan">BULAN</label>
                    <select id="bulan">
                        <option value="Januari">Januari</option>
                        <option value="Februari">Februari</option>
                        <option value="Maret">Maret</option>
                        <option value="April">April</option>
                        <option value="Mei">Mei</option>
                        <option value="Juni">Juni</option>
                        <option value="Juli">Juli</option>
                        <option value="Agustus">Agustus</option>
                        <option value="September">September</option>
                        <option value="Oktober">Oktober</option>
                        <option value="November">November</option>
                        <option value="Desember">Desember</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="tahun">TAHUN</label>
                    <input type="text" id="tahun" value="2026">
                </div>
                <div class="form-group">
                    <label for="penilai">NAMA PEJABAT PENILAI</label>
                    <input type="text" id="penilai" placeholder="Nama Pejabat Penilai">
                </div>
                <div class="form-group">
                    <label for="nipPenilai">NIP PEJABAT PENILAI</label>
                    <input type="text" id="nipPenilai" placeholder="NIP Pejabat Penilai">
                </div>
                
                <div class="default-controls no-print">
                    <button class="btn btn-default" onclick="saveAsDefault()">Simpan sebagai Default</button>
                    <button class="btn btn-remove" onclick="clearDefault()">Hapus Default</button>
                    <button class="btn btn-primary" onclick="loadDefaultData()">Muat Data Default</button>
                </div>
            </div>
        </div>
        
        <div class="print-header">
            <h1>FORMULIR KINERJA HARIAN PEGAWAI</h1>
            <div style="text-align: left; margin-bottom: 15px;">
                <p style="margin: 1px 0; line-height: 1.25;"><strong>NAMA PEGAWAI:</strong> <span id="printNama"></span></p>
                <p style="margin: 1px 0; line-height: 1.25;"><strong>NIP PEGAWAI:</strong> <span id="printNipPegawai"></span></p>
                <p style="margin: 1px 0; line-height: 1.25;"><strong>BULAN:</strong> <span id="printBulan"></span> <strong>TAHUN:</strong> <span id="printTahun"></span></p>
                <p style="margin: 1px 0; line-height: 1.25;"><strong>NAMA PEJABAT PENILAI:</strong> <span id="printPenilai"></span></p>
                <p style="margin: 1px 0; line-height: 1.25;"><strong>NIP PEJABAT PENILAI:</strong> <span id="printNipPenilai"></span></p>
            </div>
        </div>
        
        <div id="replicateModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Pilihan Replikasi</h3>
                    <button class="close-modal" onclick="closeReplicateModal()">&times;</button>
                </div>
                <p>Pilih opsi replikasi untuk tanggal: <span id="replicateSourceDate"></span></p>
                <div class="option-container">
                    <div class="option-item" onclick="selectReplicateOption(1)">
                        <input type="radio" name="replicateOption" id="option1">
                        <label for="option1">Replikasi ke hari Senin sampai Sabtu</label>
                    </div>
                    <div class="option-item" onclick="selectReplicateOption(2)">
                        <input type="radio" name="replicateOption" id="option2">
                        <label for="option2">Replikasi ke semua hari lainnya</label>
                    </div>
                </div>
                <div style="margin-top: 20px; text-align: right;">
                    <button class="btn btn-replicate" onclick="applyReplication()">Terapkan Replikasi</button>
                    <button class="btn btn-remove" onclick="closeReplicateModal()">Batal</button>
                </div>
            </div>
        </div>
        
        <div class="instructions no-print">
            <h3>Petunjuk Pengisian:</h3>
            <p>1. Isi data diri terlebih dahulu (Nama Pegawai, NIP Pegawai, Bulan, Tahun, Nama Pejabat Penilai, NIP Pejabat Penilai)</p>
            <p>2. Gunakan tombol "Simpan sebagai Default" untuk menyimpan data agar tidak perlu diisi ulang</p>
            <p>3. Klik "Buat Tabel Bulan Ini" untuk membuat tabel otomatis semua hari dalam bulan</p>
            <p>4. Pada setiap hari, gunakan tombol "Tambah Kegiatan" untuk menambahkan baris kegiatan baru pada hari yang sama</p>
            <p>5. Gunakan tombol "Hapus Kegiatan" untuk menghapus semua kegiatan pada hari tersebut</p>
            <p>6. Gunakan tombol "Hapus" di kolom aktivitas untuk menghapus satu kegiatan tertentu</p>
            <p>7. Jam default: Senin-Kamis (07:30-14:30), Jumat (07:30-11:30), Sabtu (07:30-13:00), Minggu (00:00-24:00)</p>
            <p>8. Gunakan tombol "Replikasi" untuk menyalin kegiatan dengan pilihan: Senin-Sabtu atau semua hari</p>
            <p>9. Klik "Cetak Formulir" untuk mencetak dalam format tabel yang rapi dengan margin normal Word</p>
            <p>10. <strong>CATATAN:</strong> Form cetak hanya akan menampilkan hari yang memiliki kegiatan. Hari libur atau hari tanpa kegiatan tidak akan ditampilkan.</p>
        </div>
        
        <div class="month-controls no-print">
            <div>
                <button class="btn btn-primary" onclick="generateMonthTable()">Buat Tabel Bulan Ini</button>
            </div>
            <div>
                <button class="btn btn-primary" onclick="printForm()">Cetak Formulir</button>
                <button class="btn btn-remove" onclick="clearForm()">Bersihkan Formulir</button>
            </div>
        </div>
        
        <div class="table-container">
            <table id="activityTable" class="input-table fixed-table">
                <thead>
                    <tr>
                        <th class="col-no">NO</th>
                        <th class="col-date">TANGGAL</th>
                        <th class="col-time">JAM MULAI - JAM SELESAI</th>
                        <th class="col-activity">AKTIVITAS PEGAWAI</th>
                        <th class="col-actions no-print">AKSI</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>
        
        <div class="table-container" style="display: none;">
            <table id="printActivityTable" class="print-table fixed-table">
                <thead>
                    <tr>
                        <th>NO</th>
                        <th>AKTIVITAS PEGAWAI</th>
                        <th>TANGGAL</th>
                        <th>JAM MULAI</th>
                        <th>JAM SELESAI</th>
                    </tr>
                </thead>
                <tbody id="printTableBody">
                </tbody>
            </table>
        </div>
        
        <div class="action-buttons no-print">
            <button class="btn btn-primary" onclick="printForm()">Cetak Formulir</button>
            <button class="btn btn-primary" onclick="saveData()">Simpan Data</button>
        </div>
        
        <div class="footer">
            <div class="signature-section">
                <div class="signature-content">
                    <div class="signature-line">
                        <p>Sleman,</p>
                    </div>
                    <div class="signature-line">
                        <p>Pejabat Penilai</p>
                    </div>
                    <div class="signature-line signature-space">
                        <p><strong><span id="penilaiOutput"></span></strong></p>
                    </div>
                    <div class="signature-line">
                        <p>NIP: <span id="nipPenilaiOutput"></span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Set tahun default
        document.getElementById('tahun').value = new Date().getFullYear();
        
        // Variabel global untuk menyimpan data
        let dayInfo = {};
        let replicateSourceDate = null;
        let selectedReplicateOption = null;
        
        // ================== FUNGSI UTILITAS ==================
        
        function timeToMinutes(time) {
            if (!time || time === "") return 0;
            const [hours, minutes] = time.split(':').map(Number);
            return hours * 60 + (minutes || 0);
        }
        
        function minutesToTime(minutes) {
            if (minutes < 0) minutes = 0;
            if (minutes >= 24 * 60) minutes = 23 * 60 + 59;
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
        }
        
        function getLastEndTime(day) {
            const activitiesContainer = document.getElementById(`activities-${day}`);
            if (!activitiesContainer) return null;
            
            const activityRows = activitiesContainer.querySelectorAll('.activity-row');
            let lastEndTime = 0;
            
            activityRows.forEach(row => {
                const endInput = row.querySelector('.end-time');
                if (endInput && endInput.value && endInput.value !== "") {
                    const currentEndTime = timeToMinutes(endInput.value);
                    if (currentEndTime > lastEndTime) {
                        lastEndTime = currentEndTime;
                    }
                }
            });
            
            return lastEndTime === 0 ? null : minutesToTime(lastEndTime);
        }
        
        function checkTimeConflict(day, newStartTime, newEndTime, excludeIndex = null) {
            const activitiesContainer = document.getElementById(`activities-${day}`);
            if (!activitiesContainer) return false;
            
            const activityRows = activitiesContainer.querySelectorAll('.activity-row');
            const newStart = timeToMinutes(newStartTime);
            const newEnd = timeToMinutes(newEndTime);
            
            if (newEnd <= newStart) {
                return true;
            }
            
            for (let i = 0; i < activityRows.length; i++) {
                if (excludeIndex !== null && (i + 1) === excludeIndex) continue;
                
                const startInput = activityRows[i].querySelector('.start-time');
                const endInput = activityRows[i].querySelector('.end-time');
                
                if (startInput && endInput && startInput.value && startInput.value !== "" && 
                    endInput.value && endInput.value !== "") {
                    const existingStart = timeToMinutes(startInput.value);
                    const existingEnd = timeToMinutes(endInput.value);
                    
                    if ((newStart >= existingStart && newStart < existingEnd) ||
                        (newEnd > existingStart && newEnd <= existingEnd) ||
                        (newStart <= existingStart && newEnd >= existingEnd)) {
                        return true;
                    }
                }
            }
            
            return false;
        }
        
        // ================== FUNGSI DEFAULT DATA ==================
        
        function saveAsDefault() {
            const defaultData = {
                nama: document.getElementById('nama').value,
                nipPegawai: document.getElementById('nipPegawai').value,
                penilai: document.getElementById('penilai').value,
                nipPenilai: document.getElementById('nipPenilai').value
            };
            
            if (!defaultData.nama || !defaultData.nipPegawai || !defaultData.penilai || !defaultData.nipPenilai) {
                alert('Harap lengkapi semua data sebelum menyimpan sebagai default.');
                return;
            }
            
            localStorage.setItem('employeeDefaultData', JSON.stringify(defaultData));
            alert('Data telah disimpan sebagai default. Data akan dimuat otomatis saat membuka aplikasi.');
        }
        
        function clearDefault() {
            if (confirm('Apakah Anda yakin ingin menghapus data default?')) {
                localStorage.removeItem('employeeDefaultData');
                alert('Data default telah dihapus.');
            }
        }
        
        function loadDefaultData() {
            const savedDefault = localStorage.getItem('employeeDefaultData');
            if (savedDefault) {
                const defaultData = JSON.parse(savedDefault);
                document.getElementById('nama').value = defaultData.nama || '';
                document.getElementById('nipPegawai').value = defaultData.nipPegawai || '';
                document.getElementById('penilai').value = defaultData.penilai || '';
                document.getElementById('nipPenilai').value = defaultData.nipPenilai || '';
                alert('Data default telah dimuat.');
            } else {
                alert('Tidak ada data default yang tersimpan.');
            }
        }
        
        // ================== FUNGSI UTAMA TABEL ==================
        
        function getDaysInMonth(month, year) {
            const monthIndex = [
                'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
            ].indexOf(month);
            
            return new Date(year, monthIndex + 1, 0).getDate();
        }
        
        function getDayName(date) {
            const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            return days[date.getDay()];
        }
        
        function getDefaultTimes(dayOfWeek) {
            switch(dayOfWeek) {
                case 1: // Senin
                case 2: // Selasa
                case 3: // Rabu
                case 4: // Kamis
                    return { start: '07:30', end: '14:30' };
                case 5: // Jumat
                    return { start: '07:30', end: '11:30' };
                case 6: // Sabtu
                    return { start: '07:30', end: '13:00' };
                case 0: // Minggu
                    return { start: '00:00', end: '23:59' };
                default: 
                    return { start: '', end: '' };
            }
        }
        
        function generateMonthTable() {
            const bulan = document.getElementById('bulan').value;
            const tahun = parseInt(document.getElementById('tahun').value);
            const daysInMonth = getDaysInMonth(bulan, tahun);
            
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            
            dayInfo = {};
            
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(tahun, 
                    ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                     'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'].indexOf(bulan), 
                    day);
                
                const dayOfWeek = date.getDay();
                const dayName = getDayName(date);
                
                const formattedDate = `${day} ${bulan} ${tahun} (${dayName})`;
                
                dayInfo[day] = {
                    dayOfWeek: dayOfWeek,
                    dayName: dayName,
                    date: date,
                    formattedDate: formattedDate,
                    dayNumber: day
                };
                
                const defaultTimes = getDefaultTimes(dayOfWeek);
                const isHoliday = (dayOfWeek === 0);
                
                const row = document.createElement('tr');
                row.className = isHoliday ? 'date-row holiday-row' : 'date-row';
                row.id = `row-${day}`;
                
                row.innerHTML = `
                    <td class="col-no date-cell ${isHoliday ? 'holiday-cell' : ''}" style="width: 5%; min-width: 40px; max-width: 40px; height: 15px;">
                        ${day}
                    </td>
                    <td class="col-date date-cell ${isHoliday ? 'holiday-cell' : ''}" style="width: 15%; min-width: 130px; max-width: 130px; height: 15px;">
                        ${formattedDate}
                        ${isHoliday ? '<br><span class="holiday-text">(Hari Libur)</span>' : ''}
                    </td>
                    <td class="col-time activity-time-cell" style="width: 20%; min-width: 150px;">
                        <div class="activity-container" id="activities-${day}">
                            <div class="activity-row">
                                <div class="time-input-group">
                                    <input type="time" class="time-input start-time" id="start-${day}-1" value="${defaultTimes.start}">
                                    <span class="separator">-</span>
                                    <input type="time" class="time-input end-time" id="end-${day}-1" value="${defaultTimes.end}">
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="col-activity activity-desc-cell" style="width: 50%; min-width: 350px;">
                        <div class="activity-desc-container" id="activity-descs-${day}">
                            <div class="activity-desc-row" id="activity-desc-row-${day}-1">
                                <textarea class="activity-input" id="activity-desc-${day}-1" placeholder="Deskripsi kegiatan harian"></textarea>
                                <button class="desc-remove-btn no-print" onclick="removeActivity(${day}, 1)">Hapus</button>
                            </div>
                        </div>
                    </td>
                    <td class="col-actions no-print action-buttons-cell" style="width: 10%; min-width: 140px; max-width: 140px;">
                        <div class="action-buttons-small">
                            <button class="btn btn-add" onclick="addActivity(${day})">Tambah Kegiatan</button>
                            <button class="btn btn-clear-day" onclick="clearDay(${day})">Hapus Kegiatan</button>
                            <button class="btn btn-replicate" onclick="openReplicateModal(${day})">Replikasi</button>
                        </div>
                    </td>
                `;
                
                tableBody.appendChild(row);
            }
            
            alert(`Tabel untuk bulan ${bulan} ${tahun} telah dibuat`);
        }
        
        // ================== FUNGSI MANAJEMEN KEGIATAN ==================
        
        function setupTimeValidation(day, activityId) {
            const startInput = document.getElementById(`start-${day}-${activityId}`);
            const endInput = document.getElementById(`end-${day}-${activityId}`);
            
            if (!startInput || !endInput) return;
            
            const newStartInput = startInput.cloneNode(true);
            const newEndInput = endInput.cloneNode(true);
            
            startInput.parentNode.replaceChild(newStartInput, startInput);
            endInput.parentNode.replaceChild(newEndInput, endInput);
            
            newStartInput.addEventListener('change', function() {
                validateActivityTime(day, activityId);
            });
            
            newEndInput.addEventListener('change', function() {
                validateActivityTime(day, activityId);
            });
        }
        
        function validateActivityTime(day, activityId) {
            const startInput = document.getElementById(`start-${day}-${activityId}`);
            const endInput = document.getElementById(`end-${day}-${activityId}`);
            
            if (!startInput || !endInput) return true;
            
            const startTime = startInput.value;
            const endTime = endInput.value;
            
            if (!startTime || !endTime) return true;
            
            if (timeToMinutes(endTime) <= timeToMinutes(startTime)) {
                alert(`Kegiatan ${activityId}: Jam selesai harus setelah jam mulai!`);
                const newEndTime = minutesToTime(timeToMinutes(startTime) + 60);
                endInput.value = newEndTime;
                return false;
            }
            
            if (checkTimeConflict(day, startTime, endTime, activityId)) {
                alert(`Kegiatan ${activityId}: Waktu bentrok dengan kegiatan lain!`);
                
                const lastEndTime = getLastEndTime(day);
                if (lastEndTime) {
                    const newStartTime = minutesToTime(timeToMinutes(lastEndTime) + 10);
                    startInput.value = newStartTime;
                    
                    const newEndTime = minutesToTime(timeToMinutes(newStartTime) + 60);
                    endInput.value = newEndTime;
                }
                return false;
            }
            
            return true;
        }
        
        function addActivity(day) {
            const activitiesContainer = document.getElementById(`activities-${day}`);
            const activityDescsContainer = document.getElementById(`activity-descs-${day}`);
            
            if (!activitiesContainer || !activityDescsContainer) {
                alert('Silakan buat tabel bulan terlebih dahulu!');
                return;
            }
            
            const activityCount = activitiesContainer.querySelectorAll('.activity-row').length + 1;
            
            const lastEndTime = getLastEndTime(day);
            let newStartTime, newEndTime;
            
            if (lastEndTime) {
                const lastEndMinutes = timeToMinutes(lastEndTime);
                newStartTime = minutesToTime(lastEndMinutes + 10);
                
                let newEndMinutes = lastEndMinutes + 10 + 60;
                if (newEndMinutes >= 24 * 60) newEndMinutes = 23 * 60 + 59;
                newEndTime = minutesToTime(newEndMinutes);
            } else {
                const dayInfoData = dayInfo[day];
                if (!dayInfoData) {
                    alert('Data hari tidak ditemukan. Silakan buat tabel bulan terlebih dahulu.');
                    return;
                }
                
                const defaultTimes = getDefaultTimes(dayInfoData.dayOfWeek);
                newStartTime = defaultTimes.start;
                newEndTime = defaultTimes.end;
            }
            
            if (checkTimeConflict(day, newStartTime, newEndTime)) {
                let attemptStartMinutes = timeToMinutes(newStartTime);
                let found = false;
                
                for (let attempt = 0; attempt < 10; attempt++) {
                    const attemptEndMinutes = attemptStartMinutes + 60;
                    if (!checkTimeConflict(day, minutesToTime(attemptStartMinutes), minutesToTime(attemptEndMinutes))) {
                        newStartTime = minutesToTime(attemptStartMinutes);
                        newEndTime = minutesToTime(attemptEndMinutes);
                        found = true;
                        break;
                    }
                    attemptStartMinutes += 10;
                }
                
                if (!found) {
                    alert('Tidak dapat menemukan waktu yang tersedia. Silakan atur waktu manual.');
                    return;
                }
            }
            
            const newActivityRow = document.createElement('div');
            newActivityRow.className = 'activity-row';
            newActivityRow.innerHTML = `
                <div class="time-input-group">
                    <input type="time" class="time-input start-time" id="start-${day}-${activityCount}" value="${newStartTime}">
                    <span class="separator">-</span>
                    <input type="time" class="time-input end-time" id="end-${day}-${activityCount}" value="${newEndTime}">
                </div>
            `;
            
            activitiesContainer.appendChild(newActivityRow);
            
            const newActivityDescRow = document.createElement('div');
            newActivityDescRow.className = 'activity-desc-row';
            newActivityDescRow.id = `activity-desc-row-${day}-${activityCount}`;
            newActivityDescRow.innerHTML = `
                <textarea class="activity-input" id="activity-desc-${day}-${activityCount}" placeholder="Deskripsi kegiatan harian"></textarea>
                <button class="desc-remove-btn no-print" onclick="removeActivity(${day}, ${activityCount})">Hapus</button>
            `;
            
            activityDescsContainer.appendChild(newActivityDescRow);
            
            setTimeout(() => {
                setupTimeValidation(day, activityCount);
            }, 50);
        }
        
        function addActivityWithTime(day, startTime, endTime, activityDesc) {
            const activitiesContainer = document.getElementById(`activities-${day}`);
            const activityDescsContainer = document.getElementById(`activity-descs-${day}`);
            
            if (!activitiesContainer || !activityDescsContainer) return;
            
            const activityCount = activitiesContainer.querySelectorAll('.activity-row').length + 1;
            
            if (checkTimeConflict(day, startTime, endTime)) {
                const lastEndTime = getLastEndTime(day);
                if (lastEndTime) {
                    const lastEndMinutes = timeToMinutes(lastEndTime);
                    startTime = minutesToTime(lastEndMinutes + 10);
                    endTime = minutesToTime(timeToMinutes(startTime) + 60);
                }
            }
            
            const newActivityRow = document.createElement('div');
            newActivityRow.className = 'activity-row';
            newActivityRow.innerHTML = `
                <div class="time-input-group">
                    <input type="time" class="time-input start-time" id="start-${day}-${activityCount}" value="${startTime || ''}">
                    <span class="separator">-</span>
                    <input type="time" class="time-input end-time" id="end-${day}-${activityCount}" value="${endTime || ''}">
                </div>
            `;
            
            activitiesContainer.appendChild(newActivityRow);
            
            const newActivityDescRow = document.createElement('div');
            newActivityDescRow.className = 'activity-desc-row';
            newActivityDescRow.id = `activity-desc-row-${day}-${activityCount}`;
            newActivityDescRow.innerHTML = `
                <textarea class="activity-input" id="activity-desc-${day}-${activityCount}" placeholder="Deskripsi kegiatan harian">${activityDesc || ''}</textarea>
                <button class="desc-remove-btn no-print" onclick="removeActivity(${day}, ${activityCount})">Hapus</button>
            `;
            
            activityDescsContainer.appendChild(newActivityDescRow);
            
            setTimeout(() => {
                setupTimeValidation(day, activityCount);
            }, 50);
        }
        
        // ================== FUNGSI MODAL REPLIKASI ==================
        
        function openReplicateModal(day) {
            replicateSourceDate = day;
            selectedReplicateOption = null;
            
            document.querySelectorAll('input[name="replicateOption"]').forEach(radio => {
                radio.checked = false;
            });
            
            document.querySelectorAll('.option-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            const dayInfoData = dayInfo[day];
            if (dayInfoData) {
                document.getElementById('replicateSourceDate').textContent = dayInfoData.formattedDate;
            }
            
            document.getElementById('replicateModal').style.display = 'block';
        }
        
        function closeReplicateModal() {
            document.getElementById('replicateModal').style.display = 'none';
            replicateSourceDate = null;
            selectedReplicateOption = null;
        }
        
        function selectReplicateOption(option) {
            selectedReplicateOption = option;
            
            document.querySelectorAll('.option-item').forEach((item, index) => {
                if (index === option - 1) {
                    item.classList.add('selected');
                    item.querySelector('input').checked = true;
                } else {
                    item.classList.remove('selected');
                }
            });
        }
        
        function applyReplication() {
            if (!replicateSourceDate || !selectedReplicateOption) {
                alert('Silakan pilih opsi replikasi terlebih dahulu.');
                return;
            }
            
            const sourceActivities = getActivitiesOfDay(replicateSourceDate);
            
            if (sourceActivities.length === 0) {
                alert('Tidak ada kegiatan di hari sumber untuk direplikasi.');
                return;
            }
            
            const bulan = document.getElementById('bulan').value;
            const tahun = parseInt(document.getElementById('tahun').value);
            const daysInMonth = getDaysInMonth(bulan, tahun);
            
            let replicatedCount = 0;
            
            for (let targetDay = replicateSourceDate + 1; targetDay <= daysInMonth; targetDay++) {
                const dayInfoData = dayInfo[targetDay];
                if (!dayInfoData) continue;
                
                const dayOfWeek = dayInfoData.dayOfWeek;
                
                if (selectedReplicateOption === 1 && dayOfWeek === 0) {
                    continue;
                }
                
                clearDayWithoutConfirm(targetDay);
                
                setTimeout(() => {
                    sourceActivities.forEach((activity, index) => {
                        if (index === 0) {
                            const startInput = document.getElementById(`start-${targetDay}-1`);
                            const endInput = document.getElementById(`end-${targetDay}-1`);
                            const activityInput = document.getElementById(`activity-desc-${targetDay}-1`);
                            
                            if (startInput) startInput.value = activity.start;
                            if (endInput) endInput.value = activity.end;
                            if (activityInput) activityInput.value = activity.activity;
                        } else {
                            const lastEndTime = getLastEndTime(targetDay);
                            let newStartTime = activity.start;
                            let newEndTime = activity.end;
                            
                            if (lastEndTime) {
                                if (checkTimeConflict(targetDay, newStartTime, newEndTime)) {
                                    const lastEndMinutes = timeToMinutes(lastEndTime);
                                    newStartTime = minutesToTime(lastEndMinutes + 10);
                                    const duration = timeToMinutes(activity.end) - timeToMinutes(activity.start);
                                    newEndTime = minutesToTime(timeToMinutes(newStartTime) + duration);
                                }
                            }
                            
                            addActivityWithTime(targetDay, newStartTime, newEndTime, activity.activity);
                        }
                    });
                }, 50);
                
                replicatedCount++;
            }
            
            if (replicatedCount > 0) {
                alert(`Replikasi berhasil diterapkan ke ${replicatedCount} hari.`);
            } else {
                alert('Tidak ada hari yang memenuhi kriteria replikasi.');
            }
            
            closeReplicateModal();
        }
        
        // ================== FUNGSI MANAJEMEN HARI ==================
        
        function clearDay(day) {
            if (confirm(`Apakah Anda yakin ingin menghapus semua kegiatan pada tanggal ${day}?`)) {
                clearDayWithoutConfirm(day);
            }
        }
        
        function clearDayWithoutConfirm(day) {
            const activitiesContainer = document.getElementById(`activities-${day}`);
            const activityDescsContainer = document.getElementById(`activity-descs-${day}`);
            
            if (!activitiesContainer || !activityDescsContainer) return;
            
            activitiesContainer.innerHTML = '';
            activityDescsContainer.innerHTML = '';
            
            const dayInfoData = dayInfo[day];
            const defaultTimes = getDefaultTimes(dayInfoData.dayOfWeek);
            
            activitiesContainer.innerHTML = `
                <div class="activity-row">
                    <div class="time-input-group">
                        <input type="time" class="time-input start-time" id="start-${day}-1" value="${defaultTimes.start}">
                        <span class="separator">-</span>
                        <input type="time" class="time-input end-time" id="end-${day}-1" value="${defaultTimes.end}">
                    </div>
                </div>
            `;
            
            activityDescsContainer.innerHTML = `
                <div class="activity-desc-row" id="activity-desc-row-${day}-1">
                    <textarea class="activity-input" id="activity-desc-${day}-1" placeholder="Deskripsi kegiatan harian"></textarea>
                    <button class="desc-remove-btn no-print" onclick="removeActivity(${day}, 1)">Hapus</button>
                </div>
            `;
        }
        
        function removeActivity(day, activityId) {
            if (confirm('Apakah Anda yakin ingin menghapus kegiatan ini?')) {
                const activitiesContainer = document.getElementById(`activities-${day}`);
                const activityDescsContainer = document.getElementById(`activity-descs-${day}`);
                
                if (!activitiesContainer || !activityDescsContainer) return;
                
                const activityRow = document.getElementById(`start-${day}-${activityId}`)?.closest('.activity-row');
                if (activityRow) {
                    activityRow.remove();
                }
                
                const activityDescRow = document.getElementById(`activity-desc-row-${day}-${activityId}`);
                if (activityDescRow) {
                    activityDescRow.remove();
                }
                
                if (activitiesContainer.querySelectorAll('.activity-row').length === 0) {
                    clearDayWithoutConfirm(day);
                } else {
                    renameActivityIds(day);
                }
            }
        }
        
        function renameActivityIds(day) {
            const activitiesContainer = document.getElementById(`activities-${day}`);
            const activityRows = activitiesContainer.querySelectorAll('.activity-row');
            const activityDescsContainer = document.getElementById(`activity-descs-${day}`);
            const activityDescRows = activityDescsContainer.querySelectorAll('.activity-desc-row');
            
            activityRows.forEach((row, index) => {
                const newId = index + 1;
                
                const startInput = row.querySelector('.start-time');
                const endInput = row.querySelector('.end-time');
                
                if (startInput) {
                    startInput.id = `start-${day}-${newId}`;
                }
                if (endInput) {
                    endInput.id = `end-${day}-${newId}`;
                }
                
                if (activityDescRows[index]) {
                    activityDescRows[index].id = `activity-desc-row-${day}-${newId}`;
                    
                    const textarea = activityDescRows[index].querySelector('textarea');
                    const removeButton = activityDescRows[index].querySelector('.desc-remove-btn');
                    
                    if (textarea) {
                        textarea.id = `activity-desc-${day}-${newId}`;
                    }
                    
                    if (removeButton) {
                        removeButton.setAttribute('onclick', `removeActivity(${day}, ${newId})`);
                    }
                }
            });
        }
        
        function getActivitiesOfDay(day) {
            const activities = [];
            let index = 1;
            
            while (true) {
                const startInput = document.getElementById(`start-${day}-${index}`);
                const endInput = document.getElementById(`end-${day}-${index}`);
                const activityInput = document.getElementById(`activity-desc-${day}-${index}`);
                
                if (!startInput && !endInput && !activityInput) break;
                
                activities.push({
                    start: startInput ? startInput.value : '',
                    end: endInput ? endInput.value : '',
                    activity: activityInput ? activityInput.value : ''
                });
                
                index++;
            }
            
            return activities;
        }
        
        // ================== FUNGSI CETAK (DIPERBAIKI) ==================
        
        function printForm() {
            document.getElementById('printNama').textContent = document.getElementById('nama').value || '[Nama Pegawai]';
            document.getElementById('printNipPegawai').textContent = document.getElementById('nipPegawai').value || '[NIP Pegawai]';
            document.getElementById('printBulan').textContent = document.getElementById('bulan').value;
            document.getElementById('printTahun').textContent = document.getElementById('tahun').value;
            document.getElementById('printPenilai').textContent = document.getElementById('penilai').value || '[Nama Pejabat Penilai]';
            document.getElementById('printNipPenilai').textContent = document.getElementById('nipPenilai').value || '[NIP Pejabat Penilai]';
            
            document.getElementById('penilaiOutput').textContent = document.getElementById('penilai').value || '[Nama Pejabat Penilai]';
            document.getElementById('nipPenilaiOutput').textContent = document.getElementById('nipPenilai').value || '[NIP Pejabat Penilai]';
            
            const printTableBody = document.getElementById('printTableBody');
            printTableBody.innerHTML = '';
            
            const bulan = document.getElementById('bulan').value;
            const tahun = parseInt(document.getElementById('tahun').value);
            const daysInMonth = getDaysInMonth(bulan, tahun);
            
            let activityCounter = 1;
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayInfoData = dayInfo[day];
                if (!dayInfoData) continue;
                
                const formattedDate = dayInfoData.formattedDate;
                
                let activityIndex = 1;
                let dayActivities = [];
                
                while (true) {
                    const startInput = document.getElementById(`start-${day}-${activityIndex}`);
                    const endInput = document.getElementById(`end-${day}-${activityIndex}`);
                    const activityInput = document.getElementById(`activity-desc-${day}-${activityIndex}`);
                    
                    if (!startInput && !endInput && !activityInput) break;
                    
                    const startTime = startInput ? startInput.value : '';
                    const endTime = endInput ? endInput.value : '';
                    const activity = activityInput ? activityInput.value : '';
                    
                    // PERBAIKAN: Hanya tambahkan kegiatan yang memiliki DESKRIPSI AKTIVITAS
                    // Ini memastikan hanya hari dengan kegiatan nyata yang ditampilkan
                    if (activity && activity.trim() !== '') {
                        dayActivities.push({
                            startTime: startTime,
                            endTime: endTime,
                            activity: activity.trim(),
                            formattedDate: formattedDate
                        });
                    }
                    
                    activityIndex++;
                }
                
                // PERBAIKAN: Hanya tampilkan hari yang memiliki KEGIATAN NYATA (dengan deskripsi)
                if (dayActivities.length > 0) {
                    dayActivities.forEach(item => {
                        const row = document.createElement('tr');
                        row.className = 'print-activity-row';
                        row.innerHTML = `
                            <td style="line-height: 1.0; height: 15px;">${activityCounter}</td>
                            <td style="line-height: 1.0; height: 15px;">${item.activity}</td>
                            <td style="line-height: 1.0; height: 15px;">${item.formattedDate}</td>
                            <td class="print-time" style="line-height: 1.0; height: 15px;">${item.startTime}</td>
                            <td class="print-time" style="line-height: 1.0; height: 15px;">${item.endTime}</td>
                        `;
                        printTableBody.appendChild(row);
                        activityCounter++;
                    });
                }
            }
            
            if (activityCounter === 1) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="5" style="text-align: center; height: 50px; line-height: 1.0;">Tidak ada kegiatan yang dicatat untuk bulan ini</td>
                `;
                printTableBody.appendChild(row);
            }
            
            document.querySelector('.input-table').style.display = 'none';
            document.querySelector('.print-table').parentElement.style.display = 'block';
            document.querySelector('.input-header').style.display = 'none';
            document.querySelector('.print-header').style.display = 'block';
            
            window.print();
            
            setTimeout(() => {
                document.querySelector('.input-table').style.display = 'table';
                document.querySelector('.print-table').parentElement.style.display = 'none';
                document.querySelector('.input-header').style.display = 'block';
                document.querySelector('.print-header').style.display = 'none';
            }, 100);
        }
        
        // ================== FUNGSI SIMPAN & MUAT DATA ==================
        
        function saveData() {
            const data = {
                nama: document.getElementById('nama').value,
                nipPegawai: document.getElementById('nipPegawai').value,
                bulan: document.getElementById('bulan').value,
                tahun: document.getElementById('tahun').value,
                penilai: document.getElementById('penilai').value,
                nipPenilai: document.getElementById('nipPenilai').value,
                dayInfo: dayInfo,
                activities: []
            };
            
            const bulan = document.getElementById('bulan').value;
            const tahun = parseInt(document.getElementById('tahun').value);
            const daysInMonth = getDaysInMonth(bulan, tahun);
            
            for (let day = 1; day <= daysInMonth; day++) {
                if (!dayInfo[day]) continue;
                
                const formattedDate = dayInfo[day].formattedDate;
                
                let activityIndex = 1;
                while (true) {
                    const startInput = document.getElementById(`start-${day}-${activityIndex}`);
                    const endInput = document.getElementById(`end-${day}-${activityIndex}`);
                    const activityInput = document.getElementById(`activity-desc-${day}-${activityIndex}`);
                    
                    if (!startInput && !endInput && !activityInput) break;
                    
                    const startTime = startInput ? startInput.value : '';
                    const endTime = endInput ? endInput.value : '';
                    const activity = activityInput ? activityInput.value : '';
                    
                    // PERBAIKAN: Hanya simpan kegiatan yang memiliki deskripsi
                    if (activity && activity.trim() !== '') {
                        data.activities.push({
                            day: day,
                            tanggal: formattedDate,
                            startTime: startTime,
                            endTime: endTime,
                            activity: activity
                        });
                    }
                    
                    activityIndex++;
                }
            }
            
            localStorage.setItem('kinerjaHarianData', JSON.stringify(data));
            alert('Data telah disimpan secara lokal di browser Anda');
        }
        
        function loadData() {
            const savedData = localStorage.getItem('kinerjaHarianData');
            if (savedData) {
                const data = JSON.parse(savedData);
                
                document.getElementById('nama').value = data.nama || '';
                document.getElementById('nipPegawai').value = data.nipPegawai || '';
                document.getElementById('bulan').value = data.bulan || 'Januari';
                document.getElementById('tahun').value = data.tahun || new Date().getFullYear();
                document.getElementById('penilai').value = data.penilai || '';
                document.getElementById('nipPenilai').value = data.nipPenilai || '';
                
                if (data.dayInfo) {
                    dayInfo = data.dayInfo;
                }
                
                generateMonthTable();
                
                setTimeout(() => {
                    if (data.activities && data.activities.length > 0) {
                        const activitiesByDay = {};
                        
                        data.activities.forEach(activity => {
                            if (!activitiesByDay[activity.day]) {
                                activitiesByDay[activity.day] = [];
                            }
                            activitiesByDay[activity.day].push(activity);
                        });
                        
                        Object.keys(activitiesByDay).forEach(day => {
                            const dayNum = parseInt(day);
                            const activities = activitiesByDay[dayNum];
                            
                            if (activities.length > 0) {
                                document.getElementById(`start-${dayNum}-1`).value = activities[0].startTime;
                                document.getElementById(`end-${dayNum}-1`).value = activities[0].endTime;
                                const activityInput = document.getElementById(`activity-desc-${dayNum}-1`);
                                if (activityInput) activityInput.value = activities[0].activity;
                                
                                for (let i = 1; i < activities.length; i++) {
                                    addActivityWithTime(dayNum, activities[i].startTime, activities[i].endTime, activities[i].activity);
                                }
                            }
                        });
                        
                        alert('Data sebelumnya telah dimuat');
                    }
                }, 100);
            }
        }
        
        function clearForm() {
            if (confirm('Apakah Anda yakin ingin menghapus semua data?')) {
                localStorage.removeItem('kinerjaHarianData');
                document.getElementById('tableBody').innerHTML = '';
                document.getElementById('nama').value = '';
                document.getElementById('nipPegawai').value = '';
                document.getElementById('bulan').value = 'Januari';
                document.getElementById('tahun').value = new Date().getFullYear();
                document.getElementById('penilai').value = '';
                document.getElementById('nipPenilai').value = '';
                dayInfo = {};
                alert('Formulir telah dibersihkan');
            }
        }
        
        // ================== INISIALISASI ==================
        
        window.onload = function() {
            const savedDefault = localStorage.getItem('employeeDefaultData');
            if (savedDefault) {
                const defaultData = JSON.parse(savedDefault);
                document.getElementById('nama').value = defaultData.nama || '';
                document.getElementById('nipPegawai').value = defaultData.nipPegawai || '';
                document.getElementById('penilai').value = defaultData.penilai || '';
                document.getElementById('nipPenilai').value = defaultData.nipPenilai || '';
            }
            
            loadData();
        };
        
        window.onclick = function(event) {
            const modal = document.getElementById('replicateModal');
            if (event.target === modal) {
                closeReplicateModal();
            }
        };
    </script>
</body>
</html>